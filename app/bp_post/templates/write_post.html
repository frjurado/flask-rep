{% extends 'layout.html' %}

{% block js %}
{{ super() }}
{{ pagedown.include_pagedown() }}
{% endblock %}

{% block content %}

<button type="button" class="btn btn-default" data-toggle="modal" data-target="#modal">
  <span class="glyphicon glyphicon-camera" aria-hidden="true"></span>
</button>
{{ form() }}

{% endblock %}


{% block rightcol %}
<div id="photos">
{% for image in photos %}
<div>
  <img src="{{ image.url() }}" alt="{{ image.alternative }}" width="160">
  <br>
  <p>{{ image.caption }}</p>
</div>
{% endfor %}
</div>
{% endblock %}


{% block modals %}
{{ drop_form() }}

{% endblock %}


{% block scripts %}
<script src="{{ url_for('static', filename='js/dropzone.js') }}"></script>

<script type=text/javascript>
  // var csrftoken = "{{ csrf_token() }}"
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken)
        }
    }
  });
  //
  Dropzone.options.dropForm = {
    autoProcessQueue: false,
    uploadMultiple: false,

    init: function() {
      var myDropzone = this;

      // First change the button to actually tell Dropzone to process the queue.
      this.element
          .querySelector("input[type=submit]")
          .addEventListener("click", function(e) {
        // Make sure that the form isn't actually being sent.
        e.preventDefault();
        e.stopPropagation();
        myDropzone.processQueue();
      });
      this.on("sending", function() {
        $("#uploading").removeClass("hidden");
      });
      this.on("success", function(file, response) {
        $("#photos").append(response.img);
        $("#modal").modal("hide");
      });
      this.on("error", function(files, response) {
        // some real error message?
        console.log("file couldn't be uploaded");
      });
      this.on("complete", function (file) {
        $("#uploading").addClass("hidden");
        myDropzone.removeFile(file);
      });
    }
  }
</script>
{% endblock %}
