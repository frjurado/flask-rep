{% extends 'layout.html' %}

{% block js %}
{{ super() }}
{{ pagedown.include_pagedown() }}
{% endblock %}


{% block content %}

<h2 class="post-title">
  {{ post.name }}
</h2>

<div class="post-head">
  <a href="{{ url_for('main.author', username=post.author.username) }}">
    <img src="{{ post.author.gravatar(32) }}" alt="{{ post.author.name or post.author.username }}">
  </a>
  - {{ post.created }}
  {% if post.category %}
  <br>
  {{ post.category.tree() }}
  {% endif %}
</div>

<div>
  {% for tag in post.tags %}
  <span class="label label-primary">
    {{ tag.link(classes="link-unstyled") }}
  </span>
  {% endfor %}
</div>

<div class="post-body">
{% if post.body_html %}
  {{ post.body_html | safe }}
{% else %}
  {{ post.body_md }}
{% endif %}
</div>

{% if post.author == current_user or current_user.can(Permission.EDIT_POST) %}
<div>
  {{ post.edit_link() }}
  {{ post.delete_form() }}
</div>
{% endif %}

{{ form() }}
<div class="comments">
{% if post.comments %}
  {% for comment in post.comments | sort(True, attribute="created") %}
  {{ comment() }}
  {% endfor %}
{% endif %}
</div>

{% endblock %}


{% block scripts %}
<script type=text/javascript>
    $(function() {
      var csrftoken = "{{ csrf_token() }}"
      $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken)
            }
        }
      });

    $("form").submit(function(e) {
        e.preventDefault();
        $.ajax({
            url: $(".commentForm").attr("action"),
            data: $(".commentForm").serialize(),
            type: 'POST',
            success: function(response) {
              $(".comments").prepend(response.comment);
            },
            error: function(error) {
              console.log(error);
            }
        });
    });
});

</script>
{% endblock %}
