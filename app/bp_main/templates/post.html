{% extends 'content.html' %}


{% block maincontent %}

<h2 class="post-title">
  {{ post.name }}
</h2>

<div class="post-head">
  <a href="{{ url_for('main.author', username=post.author.username) }}">
    <img src="{{ post.author.gravatar(32) }}" alt="{{ post.author.name or post.author.username }}">
  </a>
  - {{ post.created }}
  {% if post.category %}
  <br>
  {{ post.category.tree() }}
  {% endif %}
</div>

<div>
  {% for tag in post.tags %}
  <span class="label label-primary">
    {{ tag.link(classes="link-unstyled") }}
  </span>
  {% endfor %}
</div>

<div class="post-body">
{% if post.body_html %}
  {{ post.body_html | safe }}
{% else %}
  {{ post.body_md }}
{% endif %}
</div>

{% if post.author == current_user or current_user.can(Permission.EDIT_POST) %}
<div>
  {{ post.edit_link() }}
  {{ post.delete_form() }}
</div>
{% endif %}

<div class="comments">
<h4>Comments</h4>
{% for comment in post.comments | sort(attribute="created") if not comment.has_parent() %}
{{ comment() }}
{% endfor %}

  <div class="commentFormBox">

  </div>
</div>

{% endblock %}


{% block scripts %}
{{ super() }}

<script type=text/javascript>
  $(function() {
    // set csrftoken
    var csrftoken = "{{ csrf_token() }}"
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken)
        }
      }
    });
    // comment form
    var commentForm = `{{ form() }}`
    // set_ajax function
    function set_ajax(form) {
      var container = form.closest(".media-body");
      form.submit(function(e) {
        e.preventDefault();
        $.ajax({
          url: form.attr("action"),
          data: form.serialize(),
          type: 'POST',
          success: function(response) {
            form.parent(".form-box").remove();
            container.children("p").children("a").removeClass("hidden");
            container.children(".commentChildren").append(response.comment);
            main_comment_form();
          },
          error: function(error) {
            console.log(error);
          }
        });
      });
    }
    // answer_click function
    function answer_click(elements) {
      elements.click(function(e) {
        e.preventDefault();
        $('a[id^="answer"]').removeClass("hidden");
        $("form.commentForm").parent(".form-box").remove();
        $(this).addClass("hidden");
        var id = $(this).attr("id").slice(6);
        var container = $(this).closest(".media-body").children(".commentFormBox");
        container.append(commentForm);
        var form = $("form", container);
        form.attr("id", "commentForm" + id);
        form.find('input#parent_id').attr("value", id);
        set_ajax(form);
        form.find("#body_md").focus();
      });
    }
    // create main comment form function
    function main_comment_form() {
      $(".comments > .commentFormBox").append(commentForm);
      set_ajax($("form#commentForm"));
    }
    // create main comment form
    main_comment_form();
    // activate answer buttons
    answer_click($('a[id^="answer"]'));
});

</script>
{% endblock %}
