{% extends 'content.html' %}


{% block maincontent %}

{% if post.main_image %}
<div class="post-main-image">
  <div class="post-off{{ ' hidden' if post.status }}"></div>
  {{ post.main_image.img() }}

  {% if post.category %}
  <div class="post-main-image-header bg-black">
    <b>{{ post.category.tree(linked=False) }}</b>
  </div>
  {% endif %}

  {% if post.author == current_user or current_user.can(Permission.EDIT_POST) %}
  <div class="post-buttons hidden">
    {{ post.status_form() }}
    {{ post.edit_link() }}
    {{ post.delete_form() }}
  </div>
  {% endif %}

  <div class="post-main-image-footer bg-black">
    {% if not post.page %}
    <div class="pull-left">
      <a class="link-unstyled" href="{{ url_for('main.author', username=post.author.username) }}">
        {{ post.author }}
      </a>
      · {{ moment(post.created).format('LL') }}
    </div>
    {% endif %}
    <div class="pull-right">
      <a class="link-unstyled" href="#comments">
        {{ post.comment_count }}
        <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
      </a>
    </div>
  </div>
</div>

<h2 class="post-title">
  {{ post.name }}
</h2>

{% else %}
<div class="post-main-image">
  <div class="post-off{{ ' hidden' if post.status }}"></div>
  {% if post.author == current_user or current_user.can(Permission.EDIT_POST) %}
  <div class="post-buttons hidden">
    {{ post.status_form() }}
    {{ post.edit_link() }}
    {{ post.delete_form() }}
  </div>
  {% endif %}

  <h2 class="post-title">
    {{ post.name }}
  </h2>
</div>

<div class="post-no-image-footer clearfix bg-black">
  <div class="pull-left">
    {% if post.category %}
    <b>{{ post.category.tree(linked=False) }}</b> ·
    {% endif %}
    {% if not post.page %}
    <a class="link-unstyled" href="{{ url_for('main.author', username=post.author.username) }}">
      {{ post.author }}
    </a>
    · {{ moment(post.created).format('LL') }}
    {% endif %}
  </div>
  <div class="pull-right">
    <a class="link-unstyled" href="#comments">
      {{ post.comment_count }}
      <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
    </a>
  </div>
</div>

{% endif %}


<div class="post-body">
{% if post.body_html %}
  {{ post.body_html | safe }}
{% else %}
  {{ post.body_md }}
{% endif %}
</div>

<div>
  <h3>Tags</h3>
  {% if post.tags == [] %}
  <p>No tags.</p>
  {% else %}
  {% for tag in post.tags %}
  {{ tag.link() }}
  {% endfor %}
  {% endif %}
</div>

<div id="comments" class="comments">
  <h3>Comments</h3>

  {% for comment in post.comments | sort(attribute="created") if not comment.has_parent() %}
  {{ comment() }}
  {% endfor %}

  <div class="commentFormBox"></div>

</div>

{% endblock %}


{% block scripts %}
{{ super() }}

<script type=text/javascript>
  $(function() {
    // main image gadget
    $('.post-main-image').hover(
      function() {
        $(".post-buttons").removeClass("hidden");
      }, function() {
        $(".post-buttons").addClass("hidden");
      }
    )
    // set csrftoken
    var csrftoken = "{{ csrf_token() }}"
    $.ajaxSetup({
      beforeSend: function(xhr, settings) {
        if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken)
        }
      }
    });
    // comment form
    var commentForm = `{{ form() }}`
    // set_ajax function
    function set_ajax(form) {
      var container = form.closest(".media-body");
      form.submit(function(e) {
        e.preventDefault();
        $.ajax({
          url: form.attr("action"),
          data: form.serialize(),
          type: 'POST',
          success: function(response) {
            form.parent(".form-box").remove();
            container.children("p").children("a").removeClass("hidden");
            container.children(".commentChildren").append(response.comment);
            main_comment_form();
          },
          error: function(error) {
            console.log(error);
          }
        });
      });
    }
    // answer_click function
    function answer_click(elements) {
      elements.click(function(e) {
        e.preventDefault();
        $('a[id^="answer"]').removeClass("hidden");
        $("form.commentForm").parent(".form-box").remove();
        $(this).addClass("hidden");
        var id = $(this).attr("id").slice(6);
        var container = $(this).closest(".media-body").children(".commentFormBox");
        container.append(commentForm);
        var form = $("form", container);
        form.attr("id", "commentForm" + id);
        form.find('input#parent_id').attr("value", id);
        set_ajax(form);
        form.find("#body_md").focus();
      });
    }
    // create main comment form function
    function main_comment_form() {
      $(".comments > .commentFormBox").append(commentForm);
      set_ajax($("form#commentForm"));
    }
    // create main comment form
    main_comment_form();
    // activate answer buttons
    answer_click($('a[id^="answer"]'));
    //
    function set_ajax(form) {
      form.submit(function(e) {
        e.preventDefault();
        $.ajax({
          url: form.attr("action"),
          data: form.serialize(),
          type: 'POST',
          success: function(response) {
            var curtain = $(".post-off");
            if (response.status) { curtain.addClass("hidden"); }
            else { curtain.removeClass("hidden"); }
          },
          error: function(error) {
            console.log(error);
          }
        });
      });
    }
    set_ajax($(".statusForm"));
});

</script>
{% endblock %}
